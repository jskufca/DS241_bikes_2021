---
title: "Group 2: Merging Bikeshare Data"
output: html_notebook
---

```{r}
library(readr)
library(sf)
library(tmap)
library(tidyverse)
library(dplyr)
library(here)
library(janitor)
library(lubridate)
library(tidycensus)
library(ggmap)
```


```{r}
url <- "https://s3.amazonaws.com/capitalbikeshare-data/202109-capitalbikeshare-tripdata.zip"

download.file(url, destfile = here("data", "raw", "capitalshare.csv.zip"), mode = "wb")
unzip(here("data", "raw", "capitalshare.csv.zip"), exdir = here("data", "raw"))
```

```{r}
capitalshare <- read_csv(here("data", "raw", "202109-capitalbikeshare-tripdata.csv"), show_col_types = FALSE)

stations <- capitalshare %>%
  select(start_station_name, start_lat, start_lng) %>%
  distinct(start_station_name, .keep_all=TRUE)

neighborhoods <- sf::read_sf(here("data", "raw", "dc-neighborhoods"))

```

Read in geojson file from the dc-health-planning-neighborhoods open dc page.

```{r}
neigh = st_read(here("data", "raw", "dc_neigh.geojson")) %>% clean_names()
```

```{r}
df_c=readxl::read_excel(here("data","raw","neigh_cases.xlsx"), col_types = c("date", "text", "numeric")) %>% clean_names()
```

```{r}
df_cases=df_c %>%
  # (cumulative) data is only given up to Nov 17.
  filter(as_date(date) == "2021-11-17") %>% 
  separate(neighborhood,into=c("code","name"),sep = ":") %>%
  mutate(code=case_when(
    code=="N35" ~"N0",
    TRUE ~ code
  ))
```

Join neighborhood data with cases.

```{r}
neigh2=left_join(neigh,df_cases,by=c("code"))
```

Determine the number of riders that started on each day per station.

```{r}
riders_day <- capitalshare %>%
  mutate(start_date = date(started_at), end_date = date(ended_at)) %>%
  group_by(start_date, start_station_name) %>%
  summarise(riders = n()) %>%
  drop_na()
```

Add coordinates of stations by joining.

```{r}
riders_day_loc <- left_join(riders_day, stations, by = "start_station_name")
```

Change to sf format.

```{r}
riders_sf <- st_as_sf(riders_day_loc, coords = c("start_lng", "start_lat"), crs = 4326)
```

Spatial join the ridership per day with the neighborhood so we can have which neighborhood each station is in.

```{r}
stations_neigh <- st_join(riders_sf, neigh2, join = st_intersects)
```

Remove some unnecessary columns.

###############
remove covid data from dataframe
summarize ridership per neighborhood (all in september)
categorize ridership by member or casual

```{r}
neigh_covid_stations <- stations_neigh %>%
  select(-c(name.x, name.y, shapearea, shapelen, date, total_positives)) %>%
  rename(neigh = dc_hpn_name, date = start_date) 
```


```{r}
df_cases_all <- df_c %>%
  separate(neighborhood,into=c("code","neigh"),sep = ":") %>%
  mutate(code=case_when(
    code=="N35" ~"N0",
    TRUE ~ code
  ))

df2 <- inner_join(neigh_covid_stations, df_cases_all, by = c("date", "code")) %>%
  rename(neigh = neigh.x) %>%
  select(-c(neigh.y))

```







