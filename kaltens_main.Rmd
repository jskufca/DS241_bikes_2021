---
title: "Demographic data (Census Data) in Washington D.C."
author: "Team 3 - Demographics"
output: html_notebook
---

Load required packages for the specific analysis.

```{r}
library(tidycensus) # Access census data
library(tidyverse)
library(sf)         # Working with simple features - geospatial
library(tmap)
library(lubridate)  # Because we will probably see some dates
library(janitor)
library(here)       # A package I haven't taught you about before that doesn't do much, but ....
```

Define the API key to access latest census data directly from the U.S. Department of Commerce.
To get your specific (individual) API key, please visit https://api.census.gov/data/key_signup.html.
```{r}
census_api_key("72ced2515c5a0d9cc250f2fd9772b7cc36aad262")
```

Required Census codes for demographic variables. Selection is based on most popular demographic values:
Age; Gender; Ethnicity; Income


Load the available census variables to determine the codes required according to the demographic selection.
This process is only used in a static way for the determination. The variable "census_vars" is not used anymore, after this code snippet.
```{r}
census_vars <- load_variables(2018, "acs5", cache = TRUE)
```
By analyzing the codes, the following list matches the defined selection:

- **B01002_001**    Age distribution in D.C.

- **B01001_002**    Sex (Male)

- **B01001_026**    Sex (Female)

- **B01001_001**    Total population

- **B01001H_001**   Population (white)

- **B02009_001**    Population (black)

- **B19013_001**    Median household income distribution in D.C.

## The census data
Gathering the required data using the provided API.
```{r}
df_census <- get_acs(geography = "tract",                  
                  variables=c("median_inc"="B06011_001",
                              "pop"="B01001_001",
                              "pop_white"="B01001H_001",
                              "pop_black"="B02009_001",
                              "age"="B01002_001",
                              "male"="B01001_002",
                              "female"="B01001_026"),
                  state="DC",geometry=TRUE,year=2018) %>% clean_names()
```

Classify and plot the created dataframe.
```{r}
class(df_census)
plot(df_census)
```

Clean the collected census dataframe and add percentages for population and sex (based on total population).
```{r}
df_cens=df_census %>% select(-moe) %>% spread(variable,estimate) %>%
  mutate(pop_black_pct = pop_black/pop, 
         pop_white_pct=pop_white/pop, 
         male_pct=male/pop,
         female_pct=female/pop)
```

Define a function, which contains the plot of a map depending on the dataframe and a variable (as string) in form of attributes.
```{r}
print_map <- function(df, variable){
  tm_shape(df) +tm_polygons(variable, alpha=.5)
}
```

Visualize the median income distribution in Washington D.C.
```{r}
print_map(df_cens, "median_inc")
```

Visualize the age distribution in Washington D.C.
```{r}
print_map(df_cens, "age")
```

Visualize the population distribution in Washington D.C.
```{r}
print_map(df_cens, "pop")
```

Visualize the black population  distribution in Washington D.C.
```{r}
print_map(df_cens, "pop_black")
```

Visualize the white population distribution in Washington D.C.
```{r}
print_map(df_cens, "pop_white")
```

Visualize the male (sex) distribution Washington D.C.
```{r}
print_map(df_cens, "male")
```

Visualize the female (sex) distribution in Washington D.C.
```{r}
print_map(df_cens, "female")
```

# The Neighborhood Data
Read the neighborhood geolocation data from the file. 
The file can be downloaded here https://opendata.dc.gov/datasets/DCGIS::dc-health-planning-neighborhoods/about.
```{r}
neigh=st_read(here("data", "raw", "dc_neigh.geojson")) %>% clean_names()
class(neigh)
```
# The Covid Data
Read the Covid data from the file
```{r message=FALSE, warning=FALSE}
df_c=readxl::read_excel(here("data", "raw","neigh_cases.xlsx"),
                            col_types = c("date", "text", "numeric")) %>% clean_names() 

# Filter and prepare the dataframe for further evaluation
df_cases=df_c %>%
  filter(as_date(date) == "2021-11-17") %>% 
  separate(neighborhood,into=c("code","name"),sep = ":") %>%
  mutate(code=case_when(
    code=="N35" ~"N0",
    TRUE ~ code
  ))
```

## Regular joining (of dataframes)
Join neighborhoods with cases in new dataframe.
```{r}
neigh2=left_join(neigh,df_cases,by=c("code")) 
tmap_mode("view")
# Print total positive cases in map
print_map(neigh2, "total_positives")
```

```{r}
  tm_shape(neigh2) +tm_borders(col="blue",lwd=5,alpha=.2)+
  tm_shape(df_cens) +tm_borders(col="red",lwd=1,alpha=.3)
```

```{r}
df_cens_adj=df_cens %>% st_transform(4326)
```

```{r}
df_j=st_join(df_cens_adj,neigh2,largest=TRUE)
```

Since we want the geometry for the NEIGHBORHOODS, we need a different work a little harder:

```{r}
df1=df_j %>% select(median_inc, pop, pop_black, pop_white, age, male, female, total_positives, objectid) %>%
  group_by(objectid) %>%
  summarise(pop_n=sum(pop),
            pop_black_n=sum(pop_black),
            pop_white_n=sum(pop_white),
            male_n=sum(male),
            female_n=sum(female),
            age_n=sum(age)/n(),
            adj_median_income=sum(pop*median_inc)/pop_n,
            total_positives_n=sum(total_positives)/n()) 
plot(df1)
```